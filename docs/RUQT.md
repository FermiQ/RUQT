# `RUQT.f90`

## Overview

`RUQT.f90` is the main program for performing **R**eal-space **U**nabridged **Q**uantum **T**ransport calculations. It orchestrates a series of steps to calculate electron transport properties, such as transmission spectra and current-voltage (I-V) curves, through a molecular device. The program interfaces with various quantum chemistry software (QChem, Molcas, GAMESS, PySCF, Maple) to obtain necessary electronic structure information (Hamiltonian, overlap matrices) and then uses Non-Equilibrium Green's Function (NEGF) formalism.

The program defines and calls many subroutines, some of which are also defined within this file (e.g., `Get_HF_QChem`, `Get_HF_GAMESS`, matrix inversion functions, Fermi function) while others are expected to be in modules like `InterfaceMod`, `FunctionMod`, and `TypeMod`.

## Key Components

-   **`program RUQT`**: The main program block.
    -   **Initialization**:
        -   Reads the main input file name from command-line arguments.
        -   Calls `ReadInput` to load calculation parameters (orbital definitions, energy/voltage ranges, method flags, filenames, etc.).
        -   Calls `Flag_set` to determine which quantum chemistry package and theory level to use.
        -   Based on flags, calls appropriate `Get_HF_*` subroutines (e.g., `Get_HF_QChem`, `Get_HF_GAMESS`) to load Hamiltonian (`H_Two`) and overlap (`Smat`) matrices.
    -   **Electrode Setup**:
        -   Supports different electrode types, primarily "Metal_WBL" (Metal Wide Band Limit) and an older "Molecule_WBL".
        -   For "Metal_WBL":
            -   Calls `PartitionHS_MetalWBL` to divide `Smat` and `H_Two` into left, central, and right electrode/device regions.
            -   Calls `Electrodes_MetalWBL` to calculate the self-energies (`Sigma_l`, `Sigma_r`) and broadening matrices (`Gamma_L`, `Gamma_R`).
    -   **Transport Calculation**:
        -   Performs either a "current" or "transmission" calculation based on `CalcType`.
        -   **Transmission Calculation**:
            -   Iterates over a defined energy range (`energy_start` to `energy_end`).
            -   For each energy:
                -   Constructs the retarded Green's function (`gfc_r`) for the device region: `gfc_r = (energy*Smat_cen - H_Two_cen - Sigma_l - Sigma_r)^-1`.
                    -   If `hf_flag` or `dft_flag` is true, uses the direct formula.
                    -   If `cisd_flag` or `rdm_flag` is true, calls `Build_G_SD_Invert` to get `gfc_r`.
                -   Calculates the advanced Green's function (`gfc_a`) as the adjoint of `gfc_r`.
                -   Computes transmission: `T(E) = Trace(Gamma_L * gfc_r * Gamma_R * gfc_a)`.
            -   Writes energy vs. transmission data to `inputfile.negf_dat`.
        -   **Current Calculation**:
            -   First, calculates `T(E)` across the energy range as in the transmission calculation.
            -   Then, iterates over a voltage range (`volt_start` to `volt_end`).
            -   For each voltage (`temp`):
                -   Calculates current by integrating `T(E) * (fermi_l - fermi_r)` over energy.
                    -   `fermi_l` and `fermi_r` are Fermi functions for the left and right electrodes, shifted by `+/- temp/2`.
            -   Writes voltage vs. current data to `inputfile.negf_dat` (appended after transmission data).
    -   **Timing**: Calculates and prints total CPU time for the run.

-   **Subroutines defined within `RUQT.f90`**:
    -   `adjoint(A,norb)`: Calculates the adjoint (conjugate transpose) of a complex matrix `A`.
    -   `Get_HF_QChem(...)`, `Get_HF_Molcas(...)`, `Get_HF_Molcas2(...)`, `Get_HF_GAMESS(...)`, `Get_HF_PySCF(...)`, `Get_HF_libint(...)`: Subroutines to read Hamiltonian and overlap matrices from files generated by different quantum chemistry packages. Some handle ECPs (Effective Core Potentials) if present.
    -   `IntTransform(...)`: Placeholder subroutine, currently does nothing.
    -   `Calculate_Coupling_MoleculeWBL(...)`, `Electrodes_MoleculeWBL(...)`: Subroutines for an older/buggy "Molecule_WBL" electrode model.
    -   `Electrodes_MetalWBL(...)`, `PartitionHS_MetalWBL(...)`: Subroutines for partitioning matrices and calculating self-energies for the "Metal_WBL" model.
    -   `fermi_function(energy,fermi_energy,KT)`: Calculates the Fermi-Dirac distribution.
    -   `inv(A)`, `inv_real(A)`: Functions to invert complex and real matrices, respectively, using LAPACK routines (`ZGETRF`/`ZGETRI` and `DGETRF`/`DGETRI`).
    -   `FirstIndex(i,k)`, `CompositeIndex(ik,jl)`: Functions to calculate packed indices, likely for storing symmetric matrices or 2-electron integrals efficiently.
    -   `matmul_zgemm(...)`, `matmul_dgemm(...)`, `matmul_dgemm2(...)`: Matrix multiplication functions/subroutine using BLAS routines (`ZGEMM`, `DGEMM`).
    -   `ReadInput(...)`: Reads various parameters from the main input file.
    -   `Flag_set(...)`: Sets logical flags based on input strings specifying QC code and functional.

## Important Variables/Constants

-   **Matrices**: `H_Two` (Hamiltonian/Fock), `Smat` (Overlap), `Sigma_l`/`Sigma_r` (Self-energies), `Gamma_L`/`Gamma_R` (Broadening), `gfc_r`/`gfc_a` (Retarded/Advanced Green's functions).
-   **Scalars**: `energy`, `voltage`, `KT` (temperature*Boltzmann const), `Fermi_enl`/`Fermi_enr` (Fermi energies of electrodes).
-   **Control parameters**: `inputfile`, `CalcType`, `ElectrodeType`, `inputcode` (QC package), `functional` (HF, DFT, CISD, RDM).
-   **Orbital definitions**: `norb`, `numatomic`, `numfcore`, `numfvirt`, `numocc`, `numvirt`, `size_l`, `size_c`, `size_r`.
-   **`27.2114` / `27.211396132`**: Conversion factor (Hartree to eV).
-   **`1.6021766E-19`**: Elementary charge (Coulombs).
-   **`4.135667E-15`**: Planck constant (eV*s).

## Usage Examples

The program is run from the command line, providing an input file:

```bash
./RUQT.x my_calculation_input.inp
```

The `my_calculation_input.inp` file would contain parameters as read by the `ReadInput` subroutine, specifying the system, method, energy/voltage ranges, etc. The program then generates output files like `my_calculation_input.negf_dat` containing the calculated transport data.

## Dependencies and Interactions

-   **Modules**: `InterfaceMod`, `FunctionMod`, `TypeMod` are `USE`d for interfaces, functions, and custom data types.
-   **LAPACK/BLAS**: External libraries required for matrix operations like inversion (`DGETRF`, `DGETRI`, `ZGETRF`, `ZGETRI`) and multiplication (`DGEMM`, `ZGEMM`).
-   **File System**:
    -   Reads the main input file specified on the command line.
    -   Reads various data files based on `inputfile` name and `inputcode` (e.g., `_Smat`, `_Htwo`, `.scf_dat`, `.mo_dat`, `MolEl.dat`).
    -   Writes output to `inputfile.negf_dat`, and potentially `.partdat`, `.Sigma` if `write_ruqt_data` is true.
-   **Quantum Chemistry Packages**: Relies on output files from GAMESS, QChem, PySCF, Molcas, or Maple to start its calculations.
-   Calls `Build_G_SD_Invert` for correlated Green's function calculations.
```
